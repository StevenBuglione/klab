flowchart TD
  PR[PR merged into release x.y.z branch] --> TAGGER[Auto RC tagger creates vX.Y.Z-rc.N]
  TAGGER --> CI_TRIG[CI triggered on tag]
  subgraph CI
    BUILD[Build once and publish to Artifactory]
    META[Record digest D and build info]
  end
  CI_TRIG --> BUILD
  BUILD --> META
  META --> STAGE_TRIG[Trigger CD Stage with artifact ref digest D]

  subgraph STAGE
    DEPLOY_S[Deploy to Stage by digest D]
    VERIFY_S{Stage acceptable}
  end
  STAGE_TRIG --> DEPLOY_S
  DEPLOY_S --> VERIFY_S

  VERIFY_S -- No --> FIX[Devs push fixes to release x.y.z]
  FIX --> PR

  VERIFY_S -- Yes --> PROD_GATE{Prod approval}
  PROD_GATE -- Approve --> DEPLOY_P[Deploy to Prod by same digest D]
  PROD_GATE -- Reject --> STOP[Stop rollout]

  DEPLOY_P --> HEALTH{Prod healthy}
  HEALTH -- No --> ROLLBACK[Redeploy previous known good digest]
  HEALTH -- Yes --> FINALIZE[Create final tag vX.Y.Z and GitHub Release and retag artifact to vX.Y.Z]
  FINALIZE --> MAIN_FF[Fast forward main to the tag commit]
